<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å­¦ä¸šç®¡ç†</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-light: #eff6ff;
            --primary-dark: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            /* ç»†è…»çš„èƒŒæ™¯ç‚¹é˜µ */
            background-image: radial-gradient(#d1d5db 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1600px;
            gap: 20px;
            height: 92vh;
        }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-top: 4px solid var(--primary);
            overflow: hidden;
        }

        h3 {
            margin: 0 0 15px 0;
            color: var(--primary-dark);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        .btn {
            background-color: var(--primary); color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;
            transition: 0.2s; white-space: nowrap;
        }
        .btn:hover { background-color: var(--primary-dark); }
        
        input, select {
            padding: 8px; border: 1px solid var(--border-color);
            border-radius: 6px; outline: none; font-size: 14px;
        }
        input:focus, select:focus { border-color: var(--primary); }

        /* --- å·¦ä¾§å¸ƒå±€ (æ—¥å†) --- */
        .left-panel { flex: 3; display: flex; flex-direction: column; }
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header h2 { margin: 0; font-size: 20px; }
        .cal-nav-btn { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .cal-nav-btn:hover { color: var(--primary); border-color: var(--primary); }

        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            flex: 1; overflow-y: auto;
        }
        .day-name { text-align: center; color: var(--text-light); font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        
        .day-cell {
            background: #fff; border: 1px solid var(--border-color); border-radius: 8px;
            padding: 5px; position: relative; min-height: 80px; transition: 0.2s;
        }
        .day-cell:hover { border-color: var(--primary); transform: translateY(-2px); }
        .day-cell.today { background-color: var(--primary-light); border-color: var(--primary); }
        .day-num { font-weight: bold; display: block; margin-bottom: 4px; }

        .tag { font-size: 11px; padding: 2px 5px; border-radius: 4px; margin-top: 2px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag.hw { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .tag.mid { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .tag.final { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        /* --- å³ä¾§å¸ƒå±€ --- */
        .right-panel { flex: 4; display: flex; flex-direction: column; gap: 20px; }

        /* 1. ä½œä¸š & è€ƒè¯• (ç´§å‡‘å¸ƒå±€) */
        .top-section { display: flex; gap: 20px; height: 35%; }
        .hw-card { flex: 1; display: flex; flex-direction: column; }
        .exam-card { flex: 1; display: flex; flex-direction: column; }

        .task-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed var(--border-color); }
        .task-item.completed span { text-decoration: line-through; color: #ccc; }
        .exam-list { flex: 1; overflow-y: auto; }
        .exam-row { display: flex; flex-direction: column; background: #f9fafb; padding: 8px; border-radius: 6px; margin-bottom: 8px; }
        .exam-row label { font-weight: bold; font-size: 14px; margin-bottom: 4px; color: var(--text-main); }
        .exam-dates { display: flex; gap: 5px; }
        .exam-dates div { flex: 1; }
        .exam-dates span { font-size: 10px; color: var(--text-light); }
        .exam-dates input { width: 100%; font-size: 12px; padding: 4px; }

        /* 2. è¯¾è¡¨ (æ—¶é—´è½´æ ¸å¿ƒæ ·å¼) */
        .timetable-card { flex: 1; height: 65%; display: flex; flex-direction: column; }
        
        .timetable-input-bar {
            display: flex; gap: 8px; padding: 10px; background: #f8fafc; 
            border-radius: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap;
        }

        /* è¯¾è¡¨å®¹å™¨ */
        .timetable-body {
            flex: 1; display: flex; overflow-y: auto; overflow-x: auto;
            border: 1px solid var(--border-color); border-radius: 8px;
            position: relative;
        }

        /* å·¦ä¾§æ—¶é—´è½´åˆ»åº¦ */
        .time-axis {
            width: 50px; flex-shrink: 0; background: #fff;
            border-right: 1px solid var(--border-color);
            position: sticky; left: 0; z-index: 10;
        }
        .time-slot {
            height: 60px; /* 1å°æ—¶çš„é«˜åº¦ */
            border-bottom: 1px solid #f3f4f6;
            font-size: 11px; color: var(--text-light);
            text-align: center; line-height: 12px; padding-top: 4px;
        }

        /* æ˜ŸæœŸåˆ—å®¹å™¨ */
        .days-container { flex: 1; display: flex; min-width: 600px; }
        .day-col {
            flex: 1; position: relative; border-right: 1px solid #f3f4f6;
            background-image: linear-gradient(to bottom, transparent 59px, #f3f4f6 60px);
            background-size: 100% 60px; /* èƒŒæ™¯æ¨ªçº¿å¯¹åº”æ—¶é—´ */
        }
        .day-col-header {
            height: 30px; text-align: center; line-height: 30px;
            background: #fff; font-weight: bold; font-size: 13px;
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 5;
        }

        /* è¯¾ç¨‹å¡ç‰‡ (ç»å¯¹å®šä½) */
        .course-block {
            position: absolute;
            left: 4px; right: 4px;
            background: rgba(59, 130, 246, 0.9); /* è“è‰²åŠé€æ˜ */
            color: white;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: 0.2s;
            z-index: 1;
            display: flex; flex-direction: column; justify-content: center;
        }
        .course-block:hover {
            background: var(--primary-dark);
            z-index: 10; transform: scale(1.05);
        }
        .course-block .time-range { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
        .course-block .del-btn {
            position: absolute; top: 2px; right: 2px; font-size: 10px; 
            cursor: pointer; background: rgba(0,0,0,0.2); border-radius: 50%; 
            width: 16px; height: 16px; text-align: center; line-height: 16px; display: none;
        }
        .course-block:hover .del-btn { display: block; }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .container { flex-direction: column; height: auto; }
            .top-section { height: auto; flex-direction: column; }
            .timetable-card { height: 600px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card left-panel">
        <div class="calendar-header">
            <button class="cal-nav-btn" id="prevMonth">â€¹</button>
            <h2 id="monthYear">2025å¹´ 12æœˆ</h2>
            <button class="cal-nav-btn" id="nextMonth">â€º</button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom:5px;">
            <div class="day-name">æ—¥</div><div class="day-name">ä¸€</div><div class="day-name">äºŒ</div>
            <div class="day-name">ä¸‰</div><div class="day-name">å››</div><div class="day-name">äº”</div><div class="day-name">å…­</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="right-panel">
        
        <div class="top-section">
            <div class="card hw-card">
                <h3>ğŸ“ ä½œä¸šä»»åŠ¡</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="taskInput" placeholder="è¾“å…¥å†…å®¹..." style="flex:1">
                    <input type="date" id="taskDate" style="width:110px;">
                    <button class="btn" onclick="addTask()">+</button>
                </div>
                <ul class="task-list" id="taskList"></ul>
            </div>

            <div class="card exam-card">
                <h3>âš¡ è€ƒè¯•å®‰æ’</h3>
                <div class="exam-list" id="examList">
                    </div>
            </div>
        </div>

        <div class="card timetable-card">
            <h3>ğŸ“… æœ¬å­¦æœŸè¯¾è¡¨</h3>
            
            <div class="timetable-input-bar">
                <select id="courseDay" style="width:70px;">
                    <option value="1">å‘¨ä¸€</option>
                    <option value="2">å‘¨äºŒ</option>
                    <option value="3">å‘¨ä¸‰</option>
                    <option value="4">å‘¨å››</option>
                    <option value="5">å‘¨äº”</option>
                    <option value="6">å‘¨å…­</option>
                    <option value="0">å‘¨æ—¥</option>
                </select>
                <input type="time" id="courseStart" value="09:00">
                <span>è‡³</span>
                <input type="time" id="courseEnd" value="10:15">
                <input type="text" id="courseName" placeholder="è¯¾ç¨‹åç§°" style="flex:1">
                <button class="btn" onclick="addCourse()">æ·»åŠ è¯¾ç¨‹</button>
            </div>

            <div class="timetable-body">
                <div class="time-axis">
                    </div>
                
                <div class="days-container" id="daysContainer">
                    </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- å…¨å±€é…ç½® ---
    // è¯¾è¡¨æ˜¾ç¤ºèŒƒå›´ï¼šæ—©ä¸Š8ç‚¹(8*60=480) åˆ° æ™šä¸Š10ç‚¹(22*60=1320)
    const START_HOUR = 8;
    const END_HOUR = 22; 
    const TOTAL_MINUTES = (END_HOUR - START_HOUR) * 60;

    let currentDate = new Date();
    let tasks = JSON.parse(localStorage.getItem('tasks_v3')) || [];
    let courses = JSON.parse(localStorage.getItem('courses_v3')) || [];
    let exams = JSON.parse(localStorage.getItem('exams_v3')) || {};

    document.addEventListener('DOMContentLoaded', () => {
        initTimetableStructure();
        renderAll();
        
        document.getElementById('prevMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()-1); renderAll(); });
        document.getElementById('nextMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()+1); renderAll(); });
    });

    function renderAll() {
        renderTimetable();
        renderExamList();
        renderTasks();
        renderCalendar();
    }

    // --- æ ¸å¿ƒï¼šæ—¶é—´è½´è¯¾è¡¨é€»è¾‘ ---
    
    // 1. åˆå§‹åŒ–ç½‘æ ¼ç»“æ„
    function initTimetableStructure() {
        // ç”Ÿæˆå·¦ä¾§æ—¶é—´åˆ»åº¦
        const timeAxis = document.querySelector('.time-axis');
        let timeHtml = '<div style="height:30px;"></div>'; // å ä½ç¬¦ï¼Œå¯¹é½Header
        for (let h = START_HOUR; h < END_HOUR; h++) {
            timeHtml += `<div class="time-slot">${h}:00</div>`;
        }
        timeAxis.innerHTML = timeHtml;

        // ç”Ÿæˆ7å¤©åˆ—
        const daysContainer = document.getElementById('daysContainer');
        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // å‘¨ä¸€æ’ç¬¬ä¸€
        
        let daysHtml = '';
        dayOrder.forEach(d => {
            daysHtml += `
                <div class="day-col" id="dayCol-${d}">
                    <div class="day-col-header">${dayNames[d]}</div>
                    </div>
            `;
        });
        daysContainer.innerHTML = daysHtml;
    }

    // 2. æ¸²æŸ“è¯¾ç¨‹å¡ç‰‡
    function renderTimetable() {
        // æ¸…ç©ºæ—§å¡ç‰‡ï¼ˆä¿ç•™Headerï¼‰
        document.querySelectorAll('.course-block').forEach(el => el.remove());

        courses.forEach(c => {
            const col = document.getElementById(`dayCol-${c.day}`);
            if (col) {
                const block = createCourseBlock(c);
                col.appendChild(block);
            }
        });
    }

    // 3. è®¡ç®—ä½ç½®å¹¶ç”Ÿæˆå¡ç‰‡
    function createCourseBlock(course) {
        const startMin = timeToMinutes(course.start);
        const endMin = timeToMinutes(course.end);
        
        // è®¡ç®—ç›¸å¯¹ Start_Hour çš„åç§»é‡
        const offsetMin = startMin - (START_HOUR * 60);
        const duration = endMin - startMin;

        // è½¬æ¢ä¸ºç™¾åˆ†æ¯” (ç›¸å¯¹äºå®¹å™¨æ€»é«˜åº¦)
        // å®¹å™¨é«˜åº¦é€»è¾‘ï¼šæ¯å°æ—¶60pxã€‚æ€»é«˜åº¦ = (22-8) * 60 = 840px (CSSé‡ŒèƒŒæ™¯æ˜¯60pxä¸€è¡Œ)
        // è¿™é‡Œç®€å•ç›´æ¥ç”¨ pixel è®¡ç®— top/height ä¹Ÿå¯ä»¥ï¼Œä½†ç”¨ç™¾åˆ†æ¯”é€‚åº”æ€§å¥½
        // ä¸ºäº†ç²¾å‡†å¯¹é½èƒŒæ™¯çº¿ï¼Œæˆ‘ä»¬å‡è®¾å®¹å™¨é«˜åº¦ç”±å†…å®¹æ’‘å¼€ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ç»å¯¹åƒç´ å®šä½æ›´å‡†
        
        const pxPerMin = 1; // 1åˆ†é’Ÿ = 1px (ç®€å•ç²—æš´ï¼Œ1å°æ—¶=60px)
        
        const topPx = offsetMin * pxPerMin + 30; // +30 æ˜¯é¿å¼€ Header
        const heightPx = duration * pxPerMin;

        const div = document.createElement('div');
        div.className = 'course-block';
        div.style.top = `${topPx}px`;
        div.style.height = `${heightPx}px`;
        div.innerHTML = `
            <span class="del-btn" onclick="deleteCourse(${course.id})">Ã—</span>
            <div style="font-weight:bold">${course.name}</div>
            <div class="time-range">${course.start} - ${course.end}</div>
        `;
        return div;
    }

    function timeToMinutes(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    function addCourse() {
        const day = document.getElementById('courseDay').value;
        const start = document.getElementById('courseStart').value;
        const end = document.getElementById('courseEnd').value;
        const name = document.getElementById('courseName').value.trim();

        if (day && start && end && name) {
            courses.push({ id: Date.now(), day, start, end, name });
            localStorage.setItem('courses_v3', JSON.stringify(courses));
            renderAll();
            document.getElementById('courseName').value = '';
        } else {
            alert("è¯·å®Œå–„è¯¾ç¨‹ä¿¡æ¯");
        }
    }

    function deleteCourse(id) {
        if(confirm('åˆ é™¤æ­¤è¯¾ç¨‹ï¼Ÿ')) {
            courses = courses.filter(c => c.id !== id);
            localStorage.setItem('courses_v3', JSON.stringify(courses));
            renderAll();
        }
    }

    // --- è€ƒè¯•é€»è¾‘ ---
    function renderExamList() {
        const list = document.getElementById('examList');
        list.innerHTML = '';
        const subjects = [...new Set(courses.map(c => c.name))];
        
        if(subjects.length === 0) {
            list.innerHTML = '<div style="color:#999;text-align:center;font-size:12px;padding:10px;">æš‚æ— è¯¾ç¨‹</div>';
            return;
        }

        subjects.forEach(sub => {
            const data = exams[sub] || { mid: '', final: '' };
            const div = document.createElement('div');
            div.className = 'exam-row';
            div.innerHTML = `
                <label>${sub}</label>
                <div class="exam-dates">
                    <div>
                        <span>æœŸä¸­</span>
                        <input type="date" value="${data.mid}" onchange="updateExam('${sub}', 'mid', this.value)">
                    </div>
                    <div>
                        <span>æœŸæœ«</span>
                        <input type="date" value="${data.final}" onchange="updateExam('${sub}', 'final', this.value)">
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function updateExam(sub, type, val) {
        if(!exams[sub]) exams[sub] = {};
        exams[sub][type] = val;
        localStorage.setItem('exams_v3', JSON.stringify(exams));
        renderCalendar();
    }

    // --- ä½œä¸šé€»è¾‘ ---
    function addTask() {
        const text = document.getElementById('taskInput').value.trim();
        const date = document.getElementById('taskDate').value;
        if (text) {
            tasks.push({ id: Date.now(), text, date, completed: false });
            localStorage.setItem('tasks_v3', JSON.stringify(tasks));
            document.getElementById('taskInput').value = '';
            renderAll();
        }
    }

    function toggleTask(id) {
        const t = tasks.find(x => x.id === id);
        if(t) { t.completed = !t.completed; localStorage.setItem('tasks_v3', JSON.stringify(tasks)); renderTasks(); }
    }

    function renderTasks() {
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        tasks.sort((a,b) => a.completed - b.completed).forEach(t => {
            const li = document.createElement('li');
            li.className = `task-item ${t.completed ? 'completed' : ''}`;
            li.innerHTML = `
                <div style="display:flex;align-items:center;">
                    <input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask(${t.id})" style="margin-right:8px">
                    <div>
                        <div style="font-size:14px">${t.text}</div>
                        ${t.date ? `<div style="font-size:11px;color:var(--primary)">æˆªæ­¢: ${t.date}</div>` : ''}
                    </div>
                </div>
                <span style="color:#ccc;cursor:pointer;font-size:18px" onclick="deleteTask(${t.id})">Ã—</span>
            `;
            list.appendChild(li);
        });
    }
    
    function deleteTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        localStorage.setItem('tasks_v3', JSON.stringify(tasks));
        renderAll();
    }

    // --- æ—¥å†æ¸²æŸ“ ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth();
        document.getElementById('monthYear').innerText = `${y}å¹´ ${m+1}æœˆ`;

        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const div = document.createElement('div');
            div.className = `day-cell ${dateStr === new Date().toISOString().split('T')[0] ? 'today' : ''}`;
            
            let html = `<span class="day-num">${i}</span>`;
            
            // æ˜¾ç¤ºè€ƒè¯•
            Object.keys(exams).forEach(sub => {
                if(exams[sub].mid === dateStr) html += `<span class="tag mid">âš¡ ${sub}æœŸä¸­</span>`;
                if(exams[sub].final === dateStr) html += `<span class="tag final">ğŸ”¥ ${sub}æœŸæœ«</span>`;
            });
            
            // æ˜¾ç¤ºä½œä¸šDDL
            tasks.forEach(t => {
                if(!t.completed && t.date === dateStr) html += `<span class="tag hw">ğŸ“ ${t.text}</span>`;
            });

            div.innerHTML = html;
            grid.appendChild(div);
        }
    }
</script>
</body>
</html>
